---
title: "Overview of normalised expression data"
---

```{r checkPkgs, child="_checkLibraries.Rmd", include=FALSE}
```

<!-- As HTML pages are built independently, large objects need to be
reimported from disk, and smaller ones quickly recomputed. -->

```{r setup, include=FALSE}
library(scater)
library(RColorBrewer)
library(ComplexHeatmap)
sce.norm <- readRDS("rds/sce.norm.rds")
hvg.out <- readRDS("rds/hvg.out.rds")
```

# Data preparation

Let us subset the normalised data set to retain only endogenous features:

```{r excludeERCC}
sce.endo <- sce.norm[!fData(sce.norm)$is_feature_control_ERCC,]
```

In addition, let us also reorder samples by `Time`, `Status`, and `Infection`:

```{r orderSamples}
sce.endo <- sce.endo[,with(pData(sce.endo), order(Time, Status, Infection))]
dim(sce.endo)
```

Let us prepare colours to indicate phenotypes:

```{r palette9}
col9 <- brewer.pal(10, "Set3")[c(1:8, 10)]
```

# Expression heatmap {.tabset}

We may then visualised normalised and scaled expression values in
a heat map manually organised by phenotype, while allowing genes with similar
expression profiles to cluster.

First let us define a heat map annotation panel that indicates key phenotype
levels for each cell:

```{r h_column}
h_column <- HeatmapAnnotation(
  df = pData(sce.endo)[,c("Time", "Status", "Infection")],
  col = list(
    Time = c("2h" = col9[1], "4h" = col9[2], "6h" = col9[3]),
    Status=c("uninfected"=col9[4],"exposed"=col9[5],"infected"=col9[6]),
    Infection = c("Mock" = col9[7], "LT2" = col9[8], "D23580" = col9[9])
  )
)
```

We may then examine the expression data of the `r nrow(sce.endo)`
endogenous HVG defined in a previous
[section](07_highlyVariableGenes.html#identifyHVGs) :

```{r topHVG.norm}
hvg.norm <- assayData(sce.endo)[["norm_exprs"]][
    rownames(hvg.out)[order(hvg.out$bio, decreasing = TRUE)],
  ]
```

## Normalised
```{r ht.norm, fig.height=7}
ht.norm <- Heatmap(
  hvg.norm,
  name = "norm_exprs", column_title = "Normalised expression",
  top_annotation = h_column,
  cluster_rows = TRUE, cluster_columns = FALSE,
  show_row_names = FALSE, show_column_names = FALSE,
  show_row_dend = TRUE
)
draw(ht.norm)
```

## Normalised-scaled

```{r ht.scaled, fig.height=7}
ht.scaled <- Heatmap(
  t(scale(t(hvg.norm))),
  name = "scaled_exprs", column_title = "Scaled expression",
  top_annotation = h_column,
  cluster_rows = TRUE, cluster_columns = FALSE,
  show_row_names = FALSE, show_column_names = FALSE,
  show_row_dend = TRUE
)
draw(ht.scaled)
```

