---
title: "Overview of normalised expression data"
---

```{r checkPkgs, child="_checkLibraries.Rmd", include=FALSE}
```

<!-- As HTML pages are built independently, large objects need to be
reimported from disk, and smaller ones quickly recomputed. -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
library(scater)
library(scran)
library(ggplot2)
library(SummarizedExperiment)
sce.norm <- readRDS("rds/sce.norm.rds")
```

# Relative importance of experimental factors {#explanatoryVariables}

Having normalised the expression data for detected features in cells that
passed quality control, the relative importance of experimental factors---both
technical and biological---provides insight into uninteresting technical
factors that may need to be accounted for when explaining variance in the
expression data.

Let us examine the proportion of variance explained by known experimental
factors, as well as the total spike-in count in each cell:

```{r plotExplanatoryVariables}
plotExplanatoryVariables(
  sce.norm,
  exprs_values = "norm_exprs",
  variables = c(
    "counts_feature_controls_ERCC",
    "log10_counts_feature_controls_ERCC",
    "Plate", "Lane", "Time", "Status", "Infection"
    )
)
```

The above figure reinforces the effect of `Time` as the primary source of
variance in this expression data set, with substantial proportion of variance
explained for a subset of features. Next are `Status` and `Infection`
factors, while other technical factors share explanation of lower amount
of the residual variance in the data set.

# Clustering

Having normalised the expression data for detected features
in single cells that passed quality control, let us examine the unsupervised
clustering of those cells using different approaches.

## Principal component analysis (PCA) {#PCA .tabset}

Let us initially focus our attention on the two principal components that
explain the largest amount of variance in the endogenous features.

**Note 1:** Some important default values are:

* `ntop=500`: only the `500` most variable features are used
* `scale_features=TRUE`: standardises expression values so that each feature
  has unit variance; this procedure normalises the relative importance of
  features expressed at high and low levels in the calculation of principal
  components.

**Note 2:** Some important non-default values are:

* `exprs_values="norm_exprs"`: the normalised log~2~-transformed CPM are used.
* `feature_set=!isSpike(sce.norm)`: ERCC spike-in features are not considered
  (see this [earlier section](05_normalisation.html#setSpike) for the
  definition of spike-in features).

```{r plotPCASCESet_PC1and2}
sce.norm <- plotPCASCESet(
  sce.norm, ncomponents = 2, exprs_values = "norm_exprs",
  colour_by = "Treatment", shape_by = "Time",
  feature_set = !isSpike(sce.norm), return_SCESet = TRUE
)
```

The above figure emphasises the importance of the `Time` factor, significantly
associated with `PC1`; in the figure, cells progress from the earliest time
points at the lowest coordinates on `PC1` to the latest time points at the
highest coordinates of `PC1`.

In addition, `PC2` contributes to the increasingly marked separation of
stimulated cells (*i.e.*, `infected` and `stimulated`) from `uninfected` cells;
`uninfected` cells generally appear at lower coordinates than their `infected`
and `exposed` counterparts on both `PC2` and `PC1`, with this trend becoming
increasingly apparent over time.

Overall, the observations above suggest different transcriptional *paths* taken
by cells in their experimental stimuli.

The analysis may be extended to more principal components; however, by
definition those principal components will report decreasing amount of variance
in the data set:

### Status

```{r plotPCASCESet_PC1to3}
plotReducedDim.SCESet(sce.norm, 3, colour_by = "Status", shape_by = "Time") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### Infection

```{r plotPCASCESet_infection}
plotReducedDim.SCESet(sce.norm, 3, colour_by = "Infection", shape_by = "Time") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### Treatment

```{r plotPCASCESet_Treatment}
plotReducedDim.SCESet(sce.norm, 3, colour_by = "Treatment", shape_by = "Time") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

## Time-independent PCA analyses {.tabset}

In the above [section](#PCA), the overwhelming influence of the `Time` factor
likely shadows the relatively weaker effect of biologically relevant
`Infection` and `Status` factors.

Let us perform PCA at each time point:

**Note:** the panel name states the experimental factor used to *colour*
single cells (*i.e.*, `Infection` or `Status`); the other factor is then
used to *shape* each data point.

```{r}
time.sce <- list()
for (time in levels(sce.norm$Time)){
  tmp.sce <- sce.norm[,sce.norm$Time == time]
  keep_feature <- (rowMeans(counts(tmp.sce)) >= 1)
  tmp.sce <- tmp.sce[keep_feature,]
  tmp.sce <- plotPCASCESet(
    tmp.sce, exprs_values = "norm_exprs",
    feature_set = !isSpike(tmp.sce), return_SCESet = TRUE, draw_plot = FALSE
  )
  time.sce[[time]] <- tmp.sce
  rm(tmp.sce)
}
rm(time)
```

### 2h-Infection

```{r}
plotReducedDim.SCESet(
  time.sce[["2h"]], 3, colour_by = "Infection", shape_by = "Status") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### 2h-Status

```{r}
plotReducedDim.SCESet(
  time.sce[["2h"]], 3, colour_by = "Status") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### 2h-Treatment

```{r}
plotReducedDim.SCESet(
  time.sce[["2h"]], 3, colour_by = "Treatment") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### 4h-Infection

```{r}
plotReducedDim.SCESet(
  time.sce[["4h"]], 3, colour_by = "Infection", shape_by = "Status") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### 4h-Status

```{r}
plotReducedDim.SCESet(
  time.sce[["4h"]], 3, colour_by = "Status") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### 4h-Treatment

```{r}
plotReducedDim.SCESet(
  time.sce[["4h"]], 3, colour_by = "Treatment") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### 6h-Infection

```{r}
plotReducedDim.SCESet(
  time.sce[["6h"]], 3, colour_by = "Infection", shape_by = "Status") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### 6h-Status

```{r}
plotReducedDim.SCESet(
  time.sce[["6h"]], 3, colour_by="Status") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### 6h-Status

```{r}
plotReducedDim.SCESet(
  time.sce[["6h"]], 3, colour_by = "Treatment") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

## t-distributed stochastic neighbour embedding (t-SNE) {.tabset}

Let us apply the t-distributed stochastic neighbour embedding (t-SNE) dimensionality reduction technique on the normalised expression of the
`500` most variable endogenous features to check for substructure in the data set:

```{r plotTSNE}
sce.norm <- plotTSNE(
  sce.norm, ncomponents = 2, exprs_values = "norm_exprs",
  colour_by = "Status", shape_by = "Time", return_SCESet = TRUE,
  feature_set = !isSpike(sce.norm),
  rand_seed = 1794, draw_plot = FALSE
) 
```

### Status

```{r plotTSNE_status}
plotReducedDim.SCESet(sce.norm, 2, colour_by = "Status", shape_by = "Time") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### Infection

```{r plotTSNE_infection}
plotReducedDim.SCESet(sce.norm, 2, colour_by = "Infection", shape_by = "Time") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### Treatment

```{r plotTSNE_Treatment}
plotReducedDim.SCESet(sce.norm, 2, colour_by = "Treatment", shape_by = "Time") +
  theme(legend.position = "bottom", legend.box = "vertical")
```

### Gene: TNF

Alternatively, we may overlay the expression level of a particular gene onto
the data points.

```{r plotTSNE_TNF}
plotGeneId <-
  rownames(fData(sce.norm))[which(fData(sce.norm)$gene_name == "TNF")]
plotReducedDim.SCESet(
  sce.norm, ncomponents = 2,
  colour_by = plotGeneId, shape_by = "Time"
  ) + guides(colour = guide_colourbar(title = "TNF")) +
  theme(legend.position = "bottom", legend.box = "vertical")
```

## Diffusion map

Finally, let us also produce a diffusion map plot of two components as a
dimensionality reduction of the endogenous features:

```{r plotDiffusionMapSCESet}
plotDiffusionMapSCESet(
  sce.norm, exprs_values = "norm_exprs",
  colour_by = "Status", shape_by = "Time",
  feature_set = !isSpike(sce.norm),
  rand_seed = 1794
) + theme(legend.position = "bottom", legend.box = "vertical")
```
