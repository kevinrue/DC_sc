---
title: "Two-way ANOVA and k-means clustering"
---

<!-- As HTML pages are built independently, large objects need to be
reimported from disk, and smaller ones quickly recomputed. -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
library(scater)
library(broom)
library(ggplot2)
library(RColorBrewer)
library(ComplexHeatmap)
library(reshape2)
sce.endo <- readRDS("rds/sce.norm.rds")
sce.all <- readRDS("rds/sce.all.rds")
```

# Environment

Let us first define:

* a set of colours used to indicate *cluster membership*,
  *Infection* and *Status* phenotypes consistently in the upcoming sections:

```{r col.sets}
col.set3 <- brewer.pal(12, "Set3")
col.cluster <- col.set3[c(1,12,3,4,9)]; names(col.cluster) <- c(1:3,0,"NA")
col.status<-col.set3[c(3,5:6)];names(col.status)<-levels(sce.endo$Status)
col.infection<-col.set3[c(3,8,10)];names(col.infection)<-levels(sce.endo$Infection)
col.time<-col.set3[c(2,7:8)];names(col.time)<-levels(sce.endo$Time)
```

# Preprocessing

```{r}
sce.endo <- sce.norm[!isSpike(sce.norm)]
```


# Example gene

```{r}
subset(fData(sce.endo), gene_name == "MARCH1", "gene_id")
anova(lm(
  norm_exprs(sce.endo)["ENSG00000145416",] ~ sce.endo$Time * sce.endo$Treatment
))
```

```{r}
ggData <- data.frame(
  norm_exprs = norm_exprs(sce.endo)["ENSG00000145416",],
  Time = sce.endo$Time,
  Treatment = sce.endo$Treatment
)
ggplot(ggData, aes(Time, norm_exprs)) +
  geom_violin(aes(fill = Time), draw_quantiles = c(0.25,0.5,0.75)) +
  theme_minimal() + facet_grid(Treatment ~ .) + ggtitle("MARCH1")
```

# Two-way ANOVA (Time * Infection)

## All cells (including uninfected controls)

```{r}
aov2.res <- do.call("rbind", apply(
  norm_exprs(sce.endo), 1, function(ne){
    tidy(anova(lm(ne ~ sce.endo$Time * sce.endo$Treatment)))[3,2:6]
  }
))
rownames(aov2.res) <- featureNames(sce.endo)
aov2.res$gene_name <- fData(sce.endo)[,"gene_name"]
```

```{r}
ggplot(aov2.res) + geom_density(aes(-log10(p.value))) + theme_bw()
head(aov2.res[order(aov2.res$p.value),])
```

```{r}
ggData <- data.frame(
  norm_exprs = norm_exprs(sce.endo)["ENSG00000172183",],
  Time = sce.endo$Time,
  Treatment = sce.endo$Treatment
)
ggplot(ggData, aes(Time, norm_exprs)) +
  geom_violin(aes(fill = Time), draw_quantiles = c(0.25,0.5,0.75)) +
  theme_minimal() + facet_grid(Treatment ~ .) + ggtitle("ISG20")
```

```{r}
aov2.res$BH <- p.adjust(aov2.res$p.value, "BH")
sce.aov2 <- sce.endo[aov2.res$BH < 0.01,]
table(aov2.res$BH < 0.01)
```

```{r}
cellOrder <- with(pData(sce.aov2), order(Time, Infection, Status))
ha <- HeatmapAnnotation(
  df = pData(sce.aov2)[cellOrder, c("Time","Infection","Status")],
  col = list(
    Time = col.time,
    Status = col.status,
    Infection = col.infection
  )
)
hm <- Heatmap(
  norm_exprs(sce.aov2)[,cellOrder],
  name = "norm_exprs", column_title = "norm_exprs", cluster_columns = FALSE,
  top_annotation = ha, show_row_names = FALSE, show_column_names = FALSE
)
draw(hm)
```

## Without uninfected controls

```{r}
sce.stim <- sce.endo[,sce.endo$Infection != "Mock"]
dim(sce.stim)
```

```{r}
aov2.stim <- do.call("rbind", apply(
  norm_exprs(sce.stim), 1, function(ne){
    tidy(anova(lm(ne ~ sce.stim$Time * sce.stim$Treatment)))[3,2:6]
  }
))
rownames(aov2.stim) <- featureNames(sce.stim)
aov2.stim$gene_name <- fData(sce.stim)[,"gene_name"]
```

```{r}
ggplot(aov2.stim) + geom_density(aes(-log10(p.value))) + theme_bw()
head(aov2.stim[order(aov2.stim$p.value),])
```

```{r}
ggData <- data.frame(
  norm_exprs = norm_exprs(sce.stim)["ENSG00000251562",],
  Time = sce.stim$Time,
  Treatment = sce.stim$Treatment
)
ggplot(ggData, aes(Time, norm_exprs)) +
  geom_violin(aes(fill = Time), draw_quantiles = c(0.25,0.5,0.75)) +
  theme_bw() + facet_grid(~Treatment) + ggtitle("ISG20")
```

```{r}
aov2.stim$BH <- p.adjust(aov2.stim$p.value, "BH")
sce.aov2.stim <- sce.stim[aov2.stim$BH < 0.05,]
table(aov2.stim$BH < 0.05)
```

```{r}
cellOrder <- with(pData(sce.aov2.stim), order(Infection, Status, Time))
ha <- HeatmapAnnotation(
  df = pData(sce.aov2.stim)[cellOrder, c("Infection","Status","Time")],
  col = list(
    Infection = col.infection,
    Status = col.status,
    Time = col.time
  )
)
hm <- Heatmap(
  norm_exprs(sce.aov2.stim)[,cellOrder],
  name = "norm_exprs", column_title = "norm_exprs", cluster_columns = FALSE,
  top_annotation = ha, show_row_names = FALSE, show_column_names = FALSE
)
draw(hm)
```

```{r}
ggData <- data.frame(
  norm_exprs = norm_exprs(sce.stim)["ENSG00000113302",],
  Time = sce.stim$Time,
  Treatment = sce.stim$Treatment
)
ggplot(ggData, aes(Time, norm_exprs)) +
  geom_violin(aes(fill = Time), draw_quantiles = c(0.25,0.5,0.75)) +
  theme_bw() + facet_grid(~Treatment) + ggtitle("IL12B")
```

# One-way ANOVA

## D23580 infected

```{r}
sce.d23 <- sce.endo[,sce.endo$Treatment == "D23580_infected"]
dim(sce.d23)
```

```{r}
anova(lm(norm_exprs(sce.d23)["ENSG00000145416",] ~ sce.d23$Time)) # MARCH1
anova(lm(norm_exprs(sce.d23)["ENSG00000251562",] ~ sce.d23$Time)) # ISG20
```

```{r}
aov.d23 <- do.call("rbind", apply(
  norm_exprs(sce.d23), 1, function(ne){
    tidy(anova(lm(ne ~ sce.d23$Time)))[1,2:6]
  }
))
aov.d23$gene_name <- fData(sce.d23)[,"gene_name"]
aov.d23$BH <- p.adjust(aov.d23$p.value, "BH")
sce.d23.aov <- sce.d23[aov.d23$BH < 0.01 & !is.na(aov.d23$BH),]
dim(sce.d23.aov)
```

```{r density_p.value_d23}
ggplot(aov.d23) + geom_density(aes(-log10(p.value))) + theme_minimal()
```

```{r Heatmap_d23}
cellOrder <- order(sce.d23.aov$Time)
ha <- HeatmapAnnotation(
  df = pData(sce.d23.aov)[cellOrder, "Time", drop = FALSE],
  col = list(
    Time = col.time
  )
)
hm <- Heatmap(
  norm_exprs(sce.d23.aov)[,cellOrder],
  name = "norm_exprs", column_title = "norm_exprs", cluster_columns = FALSE,
  top_annotation = ha, show_row_names = FALSE, show_column_names = FALSE
)
draw(hm)
```

```{r km.d23}
km.d23 <- kmeans(norm_exprs(sce.d23.aov), 9)
table(km.d23$cluster)
```

### Cluster 1

Example gene

```{r}
N.cluster <- sum(km.d23$cluster == 1)
exprsCluster <- data.frame(
  Sample = sampleNames(sce.d23.aov),
  Time = as.numeric(gsub("h", "", pData(sce.d23.aov)[,c("Time")])),
  exprs = norm_exprs(sce.d23.aov)[names(which(km.d23$cluster == 1))[10],]
)
ggData <- melt(exprsCluster, id.vars = c("Sample","Time"), variable.name = "gene_id", value.name = "norm_exprs")
```

```{r}
ggplot(ggData, aes(as.factor(Time), norm_exprs)) +
  geom_violin(draw_quantiles = c(0.25,0.5,0.75)) + geom_jitter() +
  theme_minimal()
```

```{r}
ggplot(ggData, aes(Time, norm_exprs)) +
  geom_smooth() +
  theme_minimal()
```

```{r exprsCluster_1}
exprsCluster <- data.frame(
  Sample = sampleNames(sce.d23.aov),
  Time = as.numeric(gsub("h", "", pData(sce.d23.aov)[,c("Time")])),
  t(norm_exprs(sce.d23.aov)[names(which(km.d23$cluster == 1)),])
)
ggData <- melt(exprsCluster, id.vars = c("Sample","Time"), variable.name = "gene_id", value.name = "norm_exprs")
```

```{r ggplot_c1}
ggplot(ggData, aes(Time, norm_exprs)) +
  stat_summary(
    aes(group = gene_id), fun.y = "mean", geom = "line", alpha = 0.15) +
  scale_y_continuous(limits = range(norm_exprs(sce.endo))) +
  theme_minimal() +
  labs(
    title = "Cluster 1",
    subtitle = sprintf("%i genes", sum(km.d23$cluster == 1))
  )
```

### Automate {.tabset}

```{r}
ggplotCluster <- function(SCESet, clusters, index){
  exprsCluster <- data.frame(
    Sample = sampleNames(SCESet),
    Time = as.numeric(gsub("h", "", pData(SCESet)[,c("Time")])),
    t(norm_exprs(SCESet)[names(which(clusters == index)),])
  )
  ggData <- melt(
    exprsCluster, id.vars = c("Sample","Time"),
    variable.name = "gene_id", value.name = "norm_exprs"
  )
  ggplot(ggData, aes(Time, norm_exprs)) +
    stat_summary(
      aes(group = gene_id), fun.y = "mean", geom = "line", alpha = 0.15) +
    scale_y_continuous(limits = range(norm_exprs(sce.endo))) +
    theme_minimal() +
    labs(
      title = sprintf("Cluster %i", index),
      subtitle = sprintf("%i genes", sum(km.d23$cluster == index))
    )
}
```

#### Cluster 1

```{r}
ggplotCluster(sce.d23.aov, km.d23$cluster, 1)
```

#### Cluster 2

```{r}
ggplotCluster(sce.d23.aov, km.d23$cluster, 2)
```

#### Cluster 3

```{r}
ggplotCluster(sce.d23.aov, km.d23$cluster, 3)
```

#### Cluster 4

```{r}
ggplotCluster(sce.d23.aov, km.d23$cluster, 4)
```

#### Cluster 5

```{r}
ggplotCluster(sce.d23.aov, km.d23$cluster, 5)
```

#### Cluster 6

```{r}
ggplotCluster(sce.d23.aov, km.d23$cluster, 6)
```

#### Cluster 7

```{r}
ggplotCluster(sce.d23.aov, km.d23$cluster, 7)
```

#### Cluster 8

```{r}
ggplotCluster(sce.d23.aov, km.d23$cluster, 8)
```

#### Cluster 9

```{r}
ggplotCluster(sce.d23.aov, km.d23$cluster, 9)
```
