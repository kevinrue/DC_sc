---
title: "Dimensionality reduction of mini-bulks"
author: "Kevin Rue-Albrecht"
date: "06/01/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
stopifnot(
  require(DESeq2),
  require(ggrepel),
  require(scater)
)
sce.filtered <- readRDS("rds/sce.minibulks.filtered_excludeD3.rds")
outdir <- "004_out"; dir.create(outdir)
```

# Plotting themes

Let us first define theme elements used throughout various figures
in the following sections:

```{r PCAtheme}
PCAtheme <- theme_bw() + theme(
    legend.position = "bottom", legend.box = "vertical"
  )
```

# Normalise using DESeq2

To avoid a warning raised by `DESeq2`, let us 'clean' phenotype levels
to avoid the use of unsafe characters
(*i.e.* characters that may be interpreted by R as having a special meaning):

```{r clean_deseq2}
sce.filtered$Group_Safe <- factor(
  gsub(
    "Violet \\+", "Violet",
    gsub(
      "STM-", "",
      sce.filtered$Group
    )
  ),
  gsub(
    "Violet \\+", "Violet",
    gsub(
      "STM-", "",
      levels(sce.filtered$Group)
    )
  )
)
```

Make a `DESeqDataSet` and estimate the size factors:

```{r dds}
dds <- DESeqDataSetFromMatrix(
  countData = assay(sce.filtered, "counts"),
  colData = colData(sce.filtered)[,c("Group_Safe","Donor")],
  design= ~ Donor + Group_Safe
)
dds <- estimateSizeFactors(dds)
```

Extract transformed values:

```{r se.vsd}
assay(sce.filtered, "vsd") <- assay(vst(dds, blind=FALSE))
```

# Apply PCA

Compute the principal components:

```{r pca}
pca <- prcomp(t(assay(sce.filtered, "vsd")), scale. = TRUE)
```

Join with phenotype information:

```{r pca_cbind}
stopifnot(
  all(colnames(sce.filtered) == rownames(pca$x))
)
pca.data <- cbind(
  data.frame(pca$x),
  data.frame(colData(sce.filtered))
)
```

## Infection

```{r PCA_Infection}
ggplot(pca.data, aes(PC1, PC2)) +
  geom_point(
    aes(colour = Infection, shape = Status),
    size = 2
  ) +
  geom_text_repel(
    aes(label = paste(Time, Donor, sep = "_")),
    alpha = 0.4,
    size = rel(1.5),
    min.segment.length = unit(0, "lines")
  ) +
  theme_minimal()
```

```{r PCA_Infection_pdf, echo=FALSE}
ggsave(
  file.path(outdir, sprintf("PCA_Infection.pdf")),
  width = 6, height = 5
)
```

## Status

```{r PCA_Status}
ggplot(pca.data, aes(PC1, PC2)) +
  geom_point(
    aes(colour = Status, shape = Infection),
    size = 2
  ) +
  geom_text_repel(
    aes(label = paste(Time, Donor, sep = "_")),
    alpha = 0.4,
    size = rel(1.5),
    min.segment.length = unit(0, "lines")
  ) +
  theme_minimal()
```

```{r PCA_Status_pdf, echo=FALSE}
ggsave(
  file.path(outdir, sprintf("PCA_Status.pdf")),
  width = 6, height = 5
)
```

## Treatment

```{r PCA_Treatment}
ggplot(pca.data, aes(PC1, PC2)) +
  geom_point(
    aes(colour = Treatment, shape = Time),
    size = 2
  ) +
  geom_text_repel(
    aes(label = paste(Time, Donor, sep = "_")),
    alpha = 0.4,
    size = rel(1.5),
    min.segment.length = unit(0, "lines")
  ) +
  theme_minimal()
```

```{r PCA_Treatment_pdf, echo=FALSE}
ggsave(
  file.path(outdir, sprintf("PCA_Treatment.pdf")),
  width = 6, height = 5
)
```

# Apply t-SNE {.tabset}

Computation using the default perplexity
`floor(ncol(object)/5)`=`r floor(ncol(sce.filtered)/5)`:

```{r runTSNE}
sce.filtered <- runTSNE(
  sce.filtered, ncomponents = 2, exprs_values = "vsd",
  colour_by = "Status", shape_by = "Time",
  feature_set = !isSpike(sce.filtered),
  # perplexity = round(mean(table(sce.filtered$Group))),
  rand_seed = 1794,
  return_SCE = TRUE, draw_plot = TRUE
)
```

## Infection

```{r tSNE_infection}
colourby <- "Infection"; shapeby <- "Time"
plotReducedDim(
  sce.filtered, use_dimred = "TSNE", ncomponents = 2,
  colour_by = colourby, shape_by = shapeby) + PCAtheme
```

```{r tSNE_infection_pdf, echo=FALSE}
ggsave(
  file.path(outdir, sprintf("plotTSNE_%s.pdf", colourby)),
  width = 6, height = 5
)
```

## Status

```{r tSNE_Status}
colourby <- "Status"; shapeby <- "Time"
plotReducedDim(
  sce.filtered, use_dimred = "TSNE", ncomponents = 2,
  colour_by = colourby, shape_by = shapeby) + PCAtheme
```

```{r tSNE_Status_pdf, echo=FALSE}
ggsave(
  file.path(outdir, sprintf("plotTSNE_%s.pdf", colourby)),
  width = 6, height = 5
)
```

## Treatment

```{r tSNE_Treatment}
colourby <- "Treatment"; shapeby <- "Time"
plotReducedDim(
  sce.filtered, use_dimred = "TSNE", ncomponents = 2,
  colour_by = colourby, shape_by = shapeby) + PCAtheme
```

```{r tSNE_Treatment_pdf, echo=FALSE}
ggsave(
  file.path(outdir, sprintf("plotTSNE_%s.pdf", colourby)),
  width = 6, height = 5
)
```
